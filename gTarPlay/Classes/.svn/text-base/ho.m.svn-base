//
//  UserProfileNavigationController.m
//  gTarPlay
//
//  Created by Marty Greenia on 9/13/11.
//  Copyright 2011 Incident Technologies. All rights reserved.
//

#import "UserProfileNavigationController.h"
#import "UserProfileViewController.h"
#import "UserProfileSearchViewController.h"
#import "UserProfile.h"
#import "UserSongSession.h"
#import "UserSong.h"
#import "CloudController.h"
#import "CloudResponse.h"
#import "SongPlayerViewController.h"
#import "UserEntry.h"
#import "CustomSegmentedControl.h"
#import "FileController.h"
#import "UserResponse.h"
#import "UserProfileSelectPictureViewController.h"

extern CloudController * g_cloudController;
extern FileController * g_fileController;
extern UserController * g_userController;

@implementation UserProfileNavigationController

@synthesize m_delegate;
@synthesize m_shortcutUserProfile;

- (id)initWithNibName:(NSString *)nibNameOrNil bundle:(NSBundle *)nibBundleOrNil
{
    
    self = [super initWithNibName:nibNameOrNil bundle:nibBundleOrNil];
    
    if ( self )
    {

        self.m_title = @"Profile";
        
        // UserProfile VC
        m_userProfileViewController = [[UserProfileViewController alloc] initWithNibName:@"UserProfileViewController" bundle:nil];
        m_userProfileSearchViewController = [[UserProfileSearchViewController alloc] initWithNibName:@"UserProfileSearchViewController" bundle:nil];
        
        // Change Pic VC
        m_changePicturePopupViewController = [[UserProfileSelectPictureViewController alloc] initWithNibName:nil bundle:nil];
        m_changePicturePopupViewController.m_navigationController = self;
        m_changePicturePopupViewController.m_closeButtonImage = [UIImage imageNamed:@"XButton.png"];
        
    }
    
    return self;
    
}

- (void)dealloc
{
    
    [m_spinnerView removeFromSuperview];
    
    [m_userProfileViewController release];
    [m_userProfileSearchViewController release];
    
    [m_fetchingProfileToDisplay release];
    [m_songPlaybackViewController release];
//    [m_facebookActivityIndicator release];
    
    [m_shortcutUserProfile release];
    
    [super dealloc];
    
}

- (void)didReceiveMemoryWarning
{
    // Releases the view if it doesn't have a superview.
    [super didReceiveMemoryWarning];
    
    // Release any cached data, images, etc that aren't in use.
}

#pragma mark - View lifecycle

- (void)viewDidLoad
{
    [super viewDidLoad];
    // Do any additional setup after loading the view from its nib.
    
    [m_notifyButton setImage:[UIImage imageNamed:@"FacebookIcon.png"] forState:UIControlStateNormal];
    [m_notifyButton setImageEdgeInsets:UIEdgeInsetsMake(7.0, 13.0, 7.0, 13.0)];
    
    [m_homeButton setHidden:NO];
    [m_notifyButton setHidden:YES];
    
}

- (void)viewDidUnload
{
    [super viewDidUnload];
    // Release any retained subviews of the main view.
    // e.g. self.myOutlet = nil;
    
}

- (void)viewWillAppear:(BOOL)animated
{
    
    [self clearViewController];
    
    [m_customActivityView setHidden:NO];
    
    // Let's see if there is already some user profile data to display
    UserEntry * userEntry = [g_userController getUserEntry:0];
    
    // We don't want to show the current user if there is another user we are looking for.
    if ( userEntry != nil && m_shortcutUserProfile == nil)
    {
        [self displayUserProfile:userEntry.m_userProfile];
    }
    
    // update everything anyways
    [g_userController requestUserProfile:0 andCallbackObj:self andCallbackSel:@selector(userControllerCallback:)];
    [g_userController requestUserSessions:0 andCallbackObj:self andCallbackSel:@selector(userControllerCallback:)];
    [g_userController requestUserFollows:0 andCallbackObj:self andCallbackSel:@selector(userControllerCallback:)];
    [g_userController requestUserFollowedBy:0 andCallbackObj:self andCallbackSel:@selector(userControllerCallback:)];
    
    if ( m_shortcutUserProfile != nil )
    {
        
        m_displayCurrentUserProfile = NO;
        
        [self getAndDisplayUserProfile:m_shortcutUserProfile];
        
        self.m_shortcutUserProfile = nil;
        
    }
    else
    {
        m_displayCurrentUserProfile = YES;
    }
    
    [super viewWillAppear:animated];
    
}

- (void)viewDidAppear:(BOOL)animated
{

    // We move this here because the sampler takes a while to load.
    if ( m_songPlaybackViewController == nil )
    {
        // Song playback VC
        m_songPlaybackViewController = [[SongPlayerViewController alloc] initWithNibName:nil bundle:nil];
        m_songPlaybackViewController.m_delegate = self;
    }
    
    [super viewDidAppear:animated];
}

- (void)startSpinner
{
    
    m_spinnerView = [[UIView alloc] initWithFrame:self.view.frame];
    m_spinnerView.backgroundColor = [UIColor blackColor];
    m_spinnerView.alpha = 0.2;
    
    UIActivityIndicatorView * spinner = [[UIActivityIndicatorView alloc] initWithActivityIndicatorStyle:UIActivityIndicatorViewStyleWhiteLarge];
    
    spinner.center = m_spinnerView.center;
    spinner.color = [UIColor blackColor];
    
    [m_spinnerView addSubview:spinner];
    [self.view addSubview:m_spinnerView];
    
    [spinner startAnimating];
    
    [spinner release];
    [m_spinnerView release];
    
}

- (void)endSpinner
{
    
    [m_spinnerView removeFromSuperview];
    
    m_spinnerView = nil;
    
}

#pragma mark - UserController

- (void)userControllerCallback:(UserResponse*)userResponse
{
    
    [self endSpinner];
    
    if ( userResponse.m_status != UserResponseStatusSuccess )
    {
        // Something failed, we are probably offline
        [self.navigationController popViewControllerAnimated:YES];
        return;
    }
    
    UserEntry * userEntry = [g_userController getUserEntry:0];
    
    // first time we load up, we need to display the users profile
    if ( userEntry.m_userProfile != nil && m_displayCurrentUserProfile == YES)
    {
        m_displayCurrentUserProfile = NO;
        [m_fetchingProfileToDisplay release];
        m_fetchingProfileToDisplay = [userEntry.m_userProfile retain];
    }
    
    //
    // Update the logged in user's lists
    //
    m_userProfileViewController.m_userProfile = userEntry.m_userProfile;
    m_userProfileViewController.m_userFriendList = userEntry.m_followsList;
    
    m_userProfileSearchViewController.m_userProfile = userEntry.m_userProfile;
    m_userProfileSearchViewController.m_userFriendList = userEntry.m_followsList;
//    m_userProfileSearchViewController.m_resultsArray = userEntry.m_facebookFriendsList;
    
    [g_fileController precacheFile:userEntry.m_userProfile.m_imgFileId];
    
    // update any new info for the displayed profile
    [self updateDisplayedInfo];
    
    // refresh everything with the new status
    [m_userProfileViewController refreshTable];
    [m_userProfileViewController updateRelationship];
    [m_userProfileSearchViewController refreshTable];
    
    //
    // If the profile we want is ready, show it
    //
    if ( m_fetchingProfileToDisplay != nil )
    {
        
        UserEntry * displayedEntry = [g_userController getUserEntry:m_fetchingProfileToDisplay.m_userId];
        
        if ( displayedEntry != nil )
        {
            
            [m_fetchingProfileToDisplay release];
            
            m_fetchingProfileToDisplay = nil;
            
            [g_fileController precacheFile:displayedEntry.m_userProfile.m_imgFileId];
            
            [self displayUserProfile:displayedEntry.m_userProfile];
            
            return;
        }
    }

}

- (void)userProfileSearchCallback:(UserResponse*)userResponse
{
    
    [m_userProfileSearchViewController.m_activityIndicator stopAnimating];
    
    if ( userResponse.m_status != UserResponseStatusSuccess )
    {
        // Something failed, we are probably offline
        [self.navigationController popViewControllerAnimated:YES];
        return;
    }
    
    NSArray * foundUserProfiles = userResponse.m_searchResults;
    
    // pull down all the images
    for ( UserProfile * userProfile in foundUserProfiles )
    {
        [g_fileController precacheFile:userProfile.m_imgFileId];
    }
    
    [m_userProfileSearchViewController displayResults:foundUserProfiles];
    
}

- (void)userFacebookFriendsSearchCallback:(UserResponse*)userResponse
{

    if ( userResponse.m_status != UserResponseStatusSuccess )
    {
        // Something failed, we are probably offline
        [self.navigationController popViewControllerAnimated:YES];
        return;
    }
    
    UserEntry * userEntry = [g_userController getUserEntry:0];

    if ( userEntry.m_facebookFriendsList != nil &&
         m_userProfileSearchViewController.m_waitingForFacebookSearch == YES)
    {
                
        // pull down all the images
        for ( UserProfile * userProfile in userEntry.m_facebookFriendsList )
        {
            [g_fileController precacheFile:userProfile.m_imgFileId];
        }
        
        [m_userProfileSearchViewController.m_activityIndicator stopAnimating];
        
        [m_userProfileSearchViewController displayResults:userEntry.m_facebookFriendsList];
        
    }
    
}

#pragma mark - Animation helpers

- (void)getAndDisplayUserProfile:(UserProfile*)userProfile
{
    
    [m_customActivityView setHidden:NO];
    
//    if ( m_userProfileViewController == m_currentViewController )
    {
        // clear the VC so we get the animation in
        [self clearViewController];
    }
    
    [m_userProfileViewController clearTable];
    
    [self contractSearchBar];
    
    m_userProfileViewController.m_displayedUserProfile = userProfile;
    
    [g_userController requestUserProfile:userProfile.m_userId andCallbackObj:self andCallbackSel:@selector(userControllerCallback:)];
    [g_userController requestUserSessions:userProfile.m_userId andCallbackObj:self andCallbackSel:@selector(userControllerCallback:)];
    [g_userController requestUserFollows:userProfile.m_userId andCallbackObj:self andCallbackSel:@selector(userControllerCallback:)];
    [g_userController requestUserFollowedBy:userProfile.m_userId andCallbackObj:self andCallbackSel:@selector(userControllerCallback:)];
    
    [m_fetchingProfileToDisplay release];
    
    m_fetchingProfileToDisplay = [userProfile retain];
    
}

- (void)displayUserProfile:(UserProfile*)userProfile
{
    
    [m_customActivityView setHidden:YES];
    
    m_userProfileViewController.m_displayedUserProfile = userProfile;
    
    // Fetch updated data
    [self updateDisplayedInfo];
    
    // Update the views
    [m_userProfileViewController refreshTable];
    [m_userProfileViewController updateRelationship];
    
    [self switchInViewController:m_userProfileViewController];
    
}

- (void)updateDisplayedInfo
{
    
    //
    // Update the displayed user's state
    // 
    UserEntry * displayedEntry = [g_userController getUserEntry:m_userProfileViewController.m_displayedUserProfile.m_userId];
    
    // its ok if these are nil
    m_userProfileViewController.m_displayedUserProfile = displayedEntry.m_userProfile;
    m_userProfileViewController.m_displayedSessionsArray = displayedEntry.m_sessionsList;
    m_userProfileViewController.m_displayedFollowsArray = displayedEntry.m_followsList;
    m_userProfileViewController.m_displayedFollowedArray = displayedEntry.m_followedByList;
    
    // get profile images if we need them
    [g_fileController precacheFile:displayedEntry.m_userProfile.m_imgFileId];
    
    for ( UserProfile * userProfile in displayedEntry.m_followsList )
    {
        [g_fileController precacheFile:userProfile.m_imgFileId];
    }
    
    for ( UserProfile * userProfile in displayedEntry.m_followedByList )
    {
        [g_fileController precacheFile:userProfile.m_imgFileId];
    }

}

- (void)changeProfilePicturePopup
{
    
    [m_changePicturePopupViewController attachToSuperViewWithBlackBackground:self.view];
    
}

- (void)updateProfilePicture:(UIImage*)image
{
    
    [self startSpinner];
    
    [g_userController requestUserProfileChangePicture:image andCallbackObj:self andCallbackSel:@selector(userControllerCallback:)];
    
}

- (void)playUserSongSession:(UserSongSession*)userSongSession
{
    
    NSString * xmpBlob = [g_fileController getFileOrDownloadSync:userSongSession.m_xmpFileId];
    
    userSongSession.m_xmpBlob = xmpBlob;
    
    [m_songPlaybackViewController attachToSuperView:self.view andPlaySongSession:userSongSession];
    
}

#pragma mark - Button click handlers

- (IBAction)homeButtonClicked:(id)sender
{
    
    UserEntry * userEntry = [g_userController getUserEntry:0];
    
    // No need to show it if it is already shown
    if ( userEntry.m_userProfile == m_userProfileViewController.m_displayedUserProfile )
    {
        return;
    }
    
    [self clearViewController];
    
    [m_userProfileViewController clearTable];

    [self contractSearchBar];
    
    [self displayUserProfile:userEntry.m_userProfile];
    
}

- (IBAction)notifyButtonClicked:(id)sender
{
    
    [g_userController requestUserFacebookFriends:g_cloudController.m_facebookAccessToken andCallbackObj:self andCallbackSel:@selector(userFacebookFriendsSearchCallback:)];
    
    m_userProfileSearchViewController.m_waitingForFacebookSearch = YES;
    
    m_userProfileSearchViewController.m_resultsArray = nil;
    
    [self switchInViewController:m_userProfileSearchViewController];

    [m_userProfileSearchViewController.m_searchFacebookView setHidden:NO];
    
}

#pragma mark - Misc

- (void)addUserFollows:(UserProfile*)userProfile
{
    [self startSpinner];
    [g_userController requestAddUserFollow:userProfile.m_userId andCallbackObj:self andCallbackSel:@selector(userControllerCallback:)];
}

- (void)removeUserFollows:(UserProfile*)userProfile
{
    [self startSpinner];
    [g_userController requestRemoveUserFollow:userProfile.m_userId andCallbackObj:self andCallbackSel:@selector(userControllerCallback:)];
}

- (void)logoutUser
{
//    [g_userController requestLogoutUserCallbackObj:self andCallbackSel:@selector(nil)];
}

- (void)beginSearch
{
    // switch over to the search view 
    m_userProfileSearchViewController.m_previousViewController = m_currentViewController;

    [self switchInViewController:m_userProfileSearchViewController];
    
}

- (void)cancelSearch
{
    
    // return back to the previous controller
    [self switchInViewController:m_userProfileViewController];
    
}

- (void)searchForString:(NSString*)searchString
{
    
    [g_userController requestUserProfileSearch:searchString andCallbackObj:self andCallbackSel:@selector(userProfileSearchCallback:)];
    
}

#pragma mark - SongPlayerDelegate

- (void)songPlayerDisplayUserProfile:(UserProfile*)userProfile
{
    [self getAndDisplayUserProfile:userProfile];
}

- (void)songPlayerDisplayUserSong:(UserSong*)userSong
{
    [m_delegate userProfileNavControllerDisplaySong:userSong];
    [self.navigationController popViewControllerAnimated:YES];
}


@end